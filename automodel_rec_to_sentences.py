# -*- coding: utf-8 -*-

import re
## 要去除的符号
pop_list = "，。；、？！" #记得同步更改segment_text的
def segment_text(text):
    """
    将文本按照标点符号分割成句子列表
    """
    #print("======")
    #print(text)
    #print("========")
    sentences = re.split(r'([，。；、？！])', text)
    #print("------")
    #print(sentences)
    #print("------")
    sentences = [s for s in sentences if s.strip()]  # 去除空白元素
    #print("======")
    #print(sentences)
    #print("========")
    return sentences


def split_into_words(text):
    """
    将句子分割成单个汉字，保留标点符号
    """
    words = list(text)
    return words


def match_timestamps_to_words(text, timestamps):
    """
    将时间戳分配给对应的单词
    """
    words = split_into_words(text)
    matched = []
    ts_idx = 0

    for word in words:
        if word in pop_list:
            continue
        start, end = timestamps[ts_idx]
        matched.append([start, end])
        ts_idx += 1
    return matched


def convert_format(input_data):
    results = []
    for item in input_data:
        key = item['key']
        text = item['text']
        timestamps = item['timestamp']

        sentences = segment_text(text)
        current_ts_idx = 0

        for sentence in sentences:
            if sentence in pop_list:
                continue

            ts_list = timestamps[current_ts_idx:current_ts_idx + len(sentence)]
            text_seg = ' '.join(sentence)
            #print("======")
            #print(timestamps)
            #print("======")
            #break
            start = ts_list[0][0]
            end = ts_list[-1][1]
            matched_ts_list = match_timestamps_to_words(sentence, ts_list)

            result_item = {
                'text': sentence,
                'start': start,
                'end': end,
                'text_seg': text_seg,
                'ts_list': matched_ts_list
            }


            results.append(result_item)
            current_ts_idx += len(sentence)

    return results

# 示例输入
input_data = [{'key': 'VOICE_2',
               'text': '八百标兵奔北坡，然后下一句我们就不知道了哈。我不知道为什么他们会把那个作为一个那个绕口令的一个开始。但是我现在才知道普通话，它并不是说你读的准不准。还有一个就是你发音的圆润程度，你的每一个辅音对吧？八百标兵奔北坡，这些都是我这个波字呢，你发起来能不能很饱满，它取决于你的一个口腔的一个内部的一个体积和容积，还有你的一个口腔的闭合度，爆破力。那个纹理这个相当难搞啊。但是我们现在呃大部分呢是没有进行一个专业的播音的一个训练，除非是一些比较从事这方面的人。但是我自己呢我是对这个不太在行的，所以我才发现是的是这样子的音的时候，我就会感到非常的力，不从心。那这样子的话，他就会让我感到我好像是一个很蠢的人。而且我现在我完全不知道我在说什么，我现在面前有几本书的一二三四五六七八九十十一、十二十三十四十五十六十七十八十九。我前面这些书呢，我我觉得它的一个分类是什么？是一个专业性，或者说是一个比较偏那种科普性的，比如说授课类的，然后还有漫画类的漫，我教你怎么画画。然后呃你的职业性格是什么？求职类的魔塔中的世界，有一些还有娜拉出走，出走或归来就是社客，还有聚一刀都是社客哈。',
               'timestamp': [[1140, 1380], [1440, 1640], [1640, 1860], [1860, 2100], [2360, 2600], [2640, 2860],
                             [2860, 3100], [3720, 3880], [3880, 4120], [4140, 4240], [4240, 4360], [4360, 4540],
                             [4540, 4620], [4620, 4720], [4720, 4800], [4800, 4880], [4880, 4980], [4980, 5140],
                             [5140, 5260], [5260, 5500], [5860, 6040], [6040, 6160], [6160, 6240], [6240, 6320],
                             [6320, 6420], [6420, 6520], [6520, 6660], [6660, 6880], [6880, 7120], [7140, 7340],
                             [7340, 7580], [7640, 7820], [7820, 8040], [8040, 8240], [8240, 8420], [8420, 8540],
                             [8540, 8780], [8940, 9140], [9140, 9380], [9600, 9740], [9740, 9920], [9920, 10100],
                             [10100, 10280], [10280, 10400], [10400, 10560], [10560, 10760], [10760, 10960],
                             [10960, 11060], [11060, 11180], [11180, 11300], [11300, 11420], [11420, 11500],
                             [11500, 11600], [11600, 11700], [11700, 11940], [12280, 12520], [12540, 12720],
                             [12720, 12960], [12980, 13100], [13100, 13260], [13260, 13380], [13380, 13480],
                             [13480, 13680], [13680, 13920], [13920, 14100], [14100, 14280], [14280, 14460],
                             [14460, 14580], [14580, 14820], [15240, 15420], [15420, 15620], [15620, 15720],
                             [15720, 15800], [15800, 15960], [15960, 16200], [16480, 16720], [16780, 17020],
                             [17040, 17260], [17260, 17500], [17860, 18100], [18100, 18340], [18360, 18520],
                             [18520, 18760], [19100, 19300], [19300, 19420], [19420, 19560], [19560, 19660],
                             [19660, 19800], [19800, 20020], [20020, 20260], [20280, 20380], [20380, 20620],
                             [21260, 21500], [21580, 21820], [22020, 22260], [22420, 22660], [23000, 23240],
                             [23320, 23560], [23560, 23800], [24020, 24160], [24160, 24340], [24340, 24460],
                             [24460, 24540], [24540, 24780], [26540, 26680], [26680, 26820], [26820, 27060],
                             [27080, 27320], [27380, 27620], [27800, 28020], [28020, 28220], [28220, 28400],
                             [28400, 28640], [28820, 29000], [29000, 29120], [29120, 29200], [29200, 29380],
                             [29380, 29600], [29600, 29840], [30180, 30420], [30580, 30780], [30780, 30960],
                             [30960, 31080], [31080, 31200], [31200, 31320], [31320, 31440], [31440, 31540],
                             [31540, 31740], [31740, 31980], [31980, 32200], [32200, 32340], [32340, 32580],
                             [32800, 32980], [32980, 33160], [33160, 33280], [33280, 33400], [33400, 33620],
                             [33620, 33860], [33880, 34120], [34180, 34379], [34379, 34540], [34540, 34780],
                             [35180, 35320], [35320, 35440], [35440, 35560], [35560, 35640], [35640, 35720],
                             [35720, 35820], [35820, 35960], [35960, 36080], [36080, 36280], [36280, 36440],
                             [36440, 36680], [36680, 36920], [37240, 37460], [37460, 37640], [37640, 37880],
                             [37900, 38060], [38060, 38300], [38420, 38600], [38600, 38955], [39840, 39960],
                             [39960, 40080], [40080, 40180], [40180, 40360], [40360, 40520], [40520, 40680],
                             [40680, 40945], [41830, 41950], [41950, 42190], [42230, 42370], [42370, 42610],
                             [42630, 42790], [42790, 43030], [43390, 43630], [43710, 43870], [43870, 44050],
                             [44050, 44230], [44230, 44470], [44590, 44770], [44770, 44930], [44930, 45170],
                             [45250, 45410], [45410, 45530], [45530, 45650], [45650, 45730], [45730, 45830],
                             [45830, 46010], [46010, 46150], [46150, 46350], [46350, 46530], [46530, 46670],
                             [46670, 46770], [46770, 46870], [46870, 47010], [47010, 47250], [47290, 47430],
                             [47430, 47550], [47550, 47790], [48230, 48370], [48370, 48570], [48570, 48670],
                             [48670, 48910], [49050, 49210], [49210, 49450], [49690, 49870], [49870, 49990],
                             [49990, 50170], [50170, 50290], [50290, 50525], [51350, 51470], [51470, 51590],
                             [51590, 51810], [51810, 51950], [51950, 52190], [52190, 52330], [52330, 52470],
                             [52470, 52710], [52810, 53030], [53030, 53190], [53190, 53430], [53450, 53550],
                             [53550, 53790], [53910, 54070], [54070, 54310], [54310, 54550], [55010, 55210],
                             [55210, 55330], [55330, 55410], [55410, 55610], [55610, 55790], [55790, 56030],
                             [56090, 56330], [56330, 56570], [57010, 57415], [59160, 59320], [59320, 59400],
                             [59400, 59500], [59500, 59620], [59620, 59720], [59720, 59860], [59860, 60020],
                             [60020, 60120], [60120, 60260], [60260, 60360], [60360, 60480], [60480, 60600],
                             [60600, 60820], [60820, 60960], [60960, 61120], [61120, 61360], [61440, 61540],
                             [61540, 61700], [61700, 61900], [61900, 62225], [63550, 63710], [63710, 63830],
                             [63830, 63910], [63910, 64050], [64050, 64170], [64170, 64410], [64430, 64570],
                             [64570, 64690], [64690, 64930], [64950, 65030], [65030, 65270], [65310, 65450],
                             [65450, 65895], [66770, 66930], [66930, 67090], [67090, 67310], [67310, 67510],
                             [67510, 67650], [67650, 67890], [68110, 68310], [68310, 68550], [68590, 68710],
                             [68710, 69005], [70110, 70250], [70250, 70490], [70770, 70910], [70910, 71030],
                             [71030, 71150], [71150, 71250], [71250, 71390], [71390, 71550], [71550, 71630],
                             [71630, 71710], [71710, 71790], [71790, 71890], [71890, 72090], [72090, 72250],
                             [72250, 72490], [72870, 73030], [73030, 73130], [73130, 73270], [73270, 73430],
                             [73430, 73670], [73670, 73850], [73850, 73970], [73970, 74210], [74210, 74290],
                             [74290, 74390], [74390, 74610], [74610, 74850], [74870, 75110], [75250, 75490],
                             [75710, 75950], [76310, 76550], [76730, 76970], [77150, 77390], [77630, 77869],
                             [78030, 78270], [79070, 79310], [79610, 79770], [79770, 80010], [80030, 80250],
                             [80250, 80490], [80510, 80710], [80710, 80950], [81030, 81190], [81190, 81390],
                             [81390, 81490], [81490, 81610], [81610, 81710], [81710, 81830], [81830, 81950],
                             [81950, 82150], [82150, 82250], [82250, 82390], [82390, 82550], [82550, 82875],
                             [84340, 84500], [84500, 84600], [84600, 84800], [84800, 84960], [84960, 85060],
                             [85060, 85300], [85300, 85540], [85580, 85820], [86080, 86300], [86300, 86420],
                             [86420, 86540], [86540, 86720], [86720, 86800], [86800, 86880], [86880, 86960],
                             [86960, 87120], [87120, 87360], [87360, 87480], [87480, 87600], [87600, 87805],
                             [88670, 88910], [89010, 89210], [89210, 89450], [90290, 90530], [90590, 90830],
                             [90890, 91130], [91130, 91230], [91230, 91350], [91350, 91590], [91650, 91870],
                             [91870, 91990], [91990, 92230], [92290, 92470], [92470, 92650], [92650, 92890],
                             [92950, 93050], [93050, 93190], [93190, 93350], [93350, 93530], [93530, 93710],
                             [93710, 93945], [94870, 95070], [95070, 95190], [95190, 95430], [95510, 95750],
                             [95770, 95950], [95950, 96190], [96230, 96470], [96510, 96650], [96650, 96830],
                             [96830, 96930], [96930, 97070], [97070, 97150], [97150, 97350], [97350, 97590],
                             [97610, 97830], [97830, 98070], [98710, 98950], [98990, 99170], [99170, 99310],
                             [99310, 99390], [99390, 99490], [99490, 99690], [99690, 100045], [101050, 101290],
                             [101330, 101570], [103000, 103240], [103380, 103540], [103540, 103680], [103680, 103820],
                             [103820, 104000], [104000, 104120], [104120, 104280], [104280, 104420], [104420, 104500],
                             [104500, 104660], [104660, 104900], [104920, 105160], [105180, 105400], [105400, 105695],
                             [106460, 106700], [106700, 106880], [106880, 107000], [107000, 107160], [107160, 107300],
                             [107300, 107540], [107540, 107680], [107680, 107840], [107840, 108080], [108200, 108360],
                             [108360, 108600], [108740, 108960], [108960, 109200], [109240, 109480], [109500, 109740],
                             [110040, 110280], [110280, 110520], [110580, 110820], [110840, 111040], [111040, 111280],
                             [111300, 111460], [111460, 111700], [111780, 112000], [112000, 112240], [112520, 112700],
                             [112700, 112800], [112800, 112940], [112940, 113060], [113060, 113180], [113180, 113300],
                             [113300, 113400], [113400, 113540], [113540, 113720], [113720, 113955]]}]



def remove_chinese_punctuation(text):
    """
    测试移除文本中的中文标点符号：，。？！、
    """
    return re.sub(r'[，。？！、；“”]', '', text)
    ##如果碰到list_out_ofindex,可以打印一下看看是否有什么多余的符号。需要保证，time_stamp的长度==text长度

if __name__ == "__main__":
    print(remove_chinese_punctuation(input_data[0]["text"]))  ##去掉符号的text
    print(len(remove_chinese_punctuation(input_data[0]["text"])),len(input_data[0]["timestamp"])) ##比对长度，如果不一样，说明有多余的未加入的符号。


    output_data = convert_format(input_data)
    print(output_data)
